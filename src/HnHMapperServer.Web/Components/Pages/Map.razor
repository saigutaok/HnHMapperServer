@page "/map"
@rendermode InteractiveServer
@using HnHMapperServer.Web.Services
@using HnHMapperServer.Web.Models
@using HnHMapperServer.Web.Components.Map
@using HnHMapperServer.Web.Components.Map.Sidebar
@using HnHMapperServer.Web.Components.Map.Menus
@using HnHMapperServer.Core.Enums
@using HnHMapperServer.Core.Extensions
@using Microsoft.AspNetCore.Authorization

<PageTitle>Map Viewer</PageTitle>

<div class="map-page map-view">
    @if (!hasMapPermission)
    {
        <div class="map-loading">
            <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Warning" Class="mb-4" />
            <MudText Typo="Typo.h5" Class="mb-2">Waiting for Map Access</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">You don't have permission to view the map yet.</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">Contact an administrator to grant you Map access.</MudText>
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" />
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">Checking for permission updates...</MudText>
        </div>
    }
    else if (!isLoaded)
    {
        <div class="map-loading">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            <MudText Typo="Typo.h6" Class="mt-4">Loading map...</MudText>
        </div>
    }
    else
    {
        <MudDrawerContainer Class="map-drawer-container">
            <!-- Right-side sidebar with all panels -->
            <MapSidebar @bind-IsOpen="@isSidebarOpen"
                        State="@state"
                        Maps="@maps"
                        Markers="@allMarkers"
                        CustomMarkers="@allCustomMarkers"
                        Timers="@allTimers"
                        Characters="@allCharacters"
                        CurrentMode="@sidebarMode"
                        OnModeChanged="@((mode) => SetMode(mode))"
                        IsFollowing="@isFollowing"
                        FollowingCharacterId="@followingCharacterId"
                        MyCharacterName="@myCharacterName"
                        OnSetMyCharacter="@SetMyCharacterAsync"
                        SelectedMap="@selectedMap"
                        OverlayMap="@overlayMap"
                        OnMapSelected="@HandleMapSelectedInternal"
                        OnOverlayMapSelected="@HandleOverlayMapSelectedInternal"
                        OverlayOffsetX="@MapNavigation.OverlayOffsetX"
                        OverlayOffsetY="@MapNavigation.OverlayOffsetY"
                        OnOverlayOffsetXChanged="@HandleOverlayOffsetXChanged"
                        OnOverlayOffsetYChanged="@HandleOverlayOffsetYChanged"
                        OnSaveOverlayOffset="@HandleSaveOverlayOffset"
                        OnZoomIn="@HandleZoomIn"
                        OnZoomOut="@HandleZoomOut"
                        OnResetView="@HandleResetView"
                        OnToggleGridCoordinates="@(async (bool value) => await HandleToggleGridCoordinates(value))"
                        OnTogglePlayers="@(async (bool value) => await HandleLayerToggle(() => LayerVisibility.ShowPlayers = value))"
                        OnTogglePlayerTooltips="@(async (bool value) => await HandleLayerToggle(() => LayerVisibility.ShowPlayerTooltips = value))"
                        OnToggleMarkers="@(async (bool value) => await HandleLayerToggle(() => LayerVisibility.ShowMarkers = value))"
                        OnToggleCustomMarkers="@OnToggleCustomMarkers"
                        OnToggleThingwalls="@(async (bool value) => await HandleLayerToggle(() => LayerVisibility.ShowThingwalls = value))"
                        OnToggleThingwallTooltips="@(async (bool value) => await HandleLayerToggle(() => LayerVisibility.ShowThingwallTooltips = value))"
                        OnToggleQuests="@(async (bool value) => await HandleLayerToggle(() => LayerVisibility.ShowQuests = value))"
                        OnToggleQuestTooltips="@(async (bool value) => await HandleLayerToggle(() => LayerVisibility.ShowQuestTooltips = value))"
                        OnPlayerSelected="@SelectPlayer"
                        OnMarkerSelected="@SelectMarker"
                        OnCustomMarkerEdit="@ShowEditCustomMarkerDialog"
                        OnCustomMarkerDelete="@DeleteCustomMarkerAsync"
                        OnCustomMarkerSelected="@SelectCustomMarker"
                        OnStopFollowing="@StopFollowing"
                        OnSetTimerForMarker="@ShowSetTimerForMarkerDialog"
                        OnSetTimerForCustomMarker="@ShowSetTimerForCustomMarkerDialog"
                        HiddenMarkerGroups="@hiddenMarkerGroups"
                        OnMarkerGroupVisibilityChanged="@HandleMarkerGroupVisibilityChanged"
                        Roads="@allRoads"
                        OnRoadSelected="@SelectRoad"
                        OnRoadEdit="@ShowEditRoadDialog"
                        OnRoadDelete="@DeleteRoadAsync" />

            <MudMainContent>
                <!-- Floating Menu Button - dynamically positioned based on sidebar state -->
                <MudFab Color="Color.Primary"
                        StartIcon="@Icons.Material.Filled.Menu"
                        OnClick="@(() => isSidebarOpen = !isSidebarOpen)"
                        Style="@GetMenuButtonStyle()"
                        Size="Size.Large"
                        Class="menu-fab"
                        Title="Toggle menu">
                    @if (allCharacters.Count > 0)
                    {
                        <MudBadge Content="@allCharacters.Count" 
                                  Color="Color.Success" 
                                  Overlap="true" 
                                  Style="position: absolute; top: -8px; right: -8px;" />
                    }
                </MudFab>

                <!-- Following Indicator (floating) - positioned at top of map area -->
                @if (isFollowing && followingCharacterId.HasValue)
                {
                    <MudChip T="string" Color="Color.Success"
                             OnClose="@StopFollowing"
                             CloseIcon="@Icons.Material.Filled.Close"
                             Style="position: absolute; top: 16px; left: 16px; z-index: 1400;">
                        Following: @(allCharacters.FirstOrDefault(c => c.Id == followingCharacterId)?.Name ?? "Unknown")
                    </MudChip>
                }

                <!-- Polling Mode Indicator (floating) - shown when SSE fails and polling fallback is active -->
                @if (connectionMode == "polling")
                {
                    <MudChip T="string" Color="Color.Warning"
                             Icon="@Icons.Material.Filled.Sync"
                             Style="@GetPollingIndicatorStyle()">
                        Polling Mode
                    </MudChip>
                }

                <!-- Overlay Toggle Buttons - Top Left (below Leaflet zoom controls) -->
                <div style="position: fixed; top: 160px; left: 16px; z-index: 1400; display: flex; flex-direction: column; gap: 8px;">
                    <MudTooltip Text="Toggle Player Claims" Placement="Placement.Right">
                        <MudButton OnClick="@TogglePClaim"
                                   Variant="Variant.Filled"
                                   Color="@(showPClaim ? Color.Error : Color.Default)"
                                   Style="min-width: 40px; min-height: 40px; padding: 8px; border-radius: 50%;">
                            <img src="/gfx/customicons/pclaim.png" alt="PClaim" style="width: 24px; height: 24px; @(showPClaim ? "" : "opacity: 0.5;")" />
                        </MudButton>
                    </MudTooltip>

                    <MudTooltip Text="Toggle Village Claims" Placement="Placement.Right">
                        <MudButton OnClick="@ToggleVClaim"
                                   Variant="Variant.Filled"
                                   Color="@(showVClaim ? Color.Warning : Color.Default)"
                                   Style="min-width: 40px; min-height: 40px; padding: 8px; border-radius: 50%;">
                            <img src="/gfx/customicons/vclaim.png" alt="VClaim" style="width: 24px; height: 24px; @(showVClaim ? "" : "opacity: 0.5;")" />
                        </MudButton>
                    </MudTooltip>

                    <MudTooltip Text="Toggle Provinces" Placement="Placement.Right">
                        <MudButton OnClick="@ToggleProvince"
                                   Variant="Variant.Filled"
                                   Color="@(showProvince ? Color.Info : Color.Default)"
                                   Style="min-width: 40px; min-height: 40px; padding: 8px; border-radius: 50%;">
                            <img src="/gfx/hud/wndmap/btns/realm.png" alt="Provinces" style="width: 24px; height: 24px; @(showProvince ? "" : "opacity: 0.5;")" />
                        </MudButton>
                    </MudTooltip>

                    <MudTooltip Text="Toggle Thingwall Highlighting" Placement="Placement.Right">
                        <MudButton OnClick="@ToggleThingwallHighlight"
                                   Variant="Variant.Filled"
                                   Color="@(showThingwallHighlight ? Color.Info : Color.Default)"
                                   Style="min-width: 40px; min-height: 40px; padding: 8px; border-radius: 50%;">
                            <img src="/gfx/terobjs/mm/thingwall.png" alt="Thingwall"
                                 style="width: 24px; height: 24px; @(showThingwallHighlight ? "" : "opacity: 0.5;")" />
                        </MudButton>
                    </MudTooltip>

                    <MudTooltip Text="Toggle Quest Giver Highlighting" Placement="Placement.Right">
                        <MudButton OnClick="@ToggleQuestGiverHighlight"
                                   Variant="Variant.Filled"
                                   Color="@(showQuestGiverHighlight ? Color.Success : Color.Default)"
                                   Style="min-width: 40px; min-height: 40px; padding: 8px; border-radius: 50%;">
                            <img src="/gfx/invobjs/small/bush.png" alt="Quest Givers"
                                 style="width: 24px; height: 24px; @(showQuestGiverHighlight ? "" : "opacity: 0.5;")" />
                        </MudButton>
                    </MudTooltip>

                    <MudTooltip Text="Toggle Roads" Placement="Placement.Right">
                        <MudButton OnClick="@ToggleRoads"
                                   Variant="Variant.Filled"
                                   Color="@(showRoads ? Color.Warning : Color.Default)"
                                   Style="min-width: 40px; min-height: 40px; padding: 8px; border-radius: 50%;">
                            <MudIcon Icon="@Icons.Material.Filled.Timeline"
                                     Style="@(showRoads ? "" : "opacity: 0.5;")" />
                        </MudButton>
                    </MudTooltip>

                    <MudTooltip Text="Marker Filter Mode (show only highlighted markers)" Placement="Placement.Right">
                        <MudButton OnClick="@ToggleMarkerFilterMode"
                                   Variant="Variant.Filled"
                                   Color="@(showMarkerFilterMode ? Color.Warning : Color.Default)"
                                   Style="min-width: 40px; min-height: 40px; padding: 8px; border-radius: 50%;">
                            <MudIcon Icon="@Icons.Material.Filled.FilterAlt"
                                     Style="@(showMarkerFilterMode ? "" : "opacity: 0.5;")" />
                        </MudButton>
                    </MudTooltip>

                    <MudTooltip Text="Toggle Marker Clustering (improves performance with many markers)" Placement="Placement.Right">
                        <MudButton OnClick="@ToggleClustering"
                                   Variant="Variant.Filled"
                                   Color="@(showClustering ? Color.Primary : Color.Default)"
                                   Style="min-width: 40px; min-height: 40px; padding: 8px; border-radius: 50%;">
                            <MudIcon Icon="@Icons.Material.Filled.BubbleChart"
                                     Style="@(showClustering ? "" : "opacity: 0.5;")" />
                        </MudButton>
                    </MudTooltip>

                    <MudTooltip Text="@(string.IsNullOrEmpty(myCharacterName) ? "Set your character first (in Players panel)" : $"Follow {myCharacterName}")" Placement="Placement.Right">
                        <MudButton OnClick="@FollowMyCharacterAsync"
                                   Disabled="@string.IsNullOrEmpty(myCharacterName)"
                                   Variant="Variant.Filled"
                                   Color="@GetFollowMyCharacterButtonColor()"
                                   Style="min-width: 40px; min-height: 40px; padding: 8px; border-radius: 50%;">
                            <MudIcon Icon="@Icons.Material.Filled.PersonPinCircle" />
                        </MudButton>
                    </MudTooltip>
                </div>

                <!-- Go to Ping Button (floating) - positioned at top center of map area, only shown when there are active pings -->
                @if (hasActivePing)
                {
                    <div style="position: absolute; top: 16px; left: 50%; transform: translateX(-50%); z-index: 1400;">
                        <MudButton Color="Color.Error"
                                   Variant="Variant.Filled"
                                   StartIcon="@Icons.Material.Filled.LocationSearching"
                                   OnClick="@HandleGoToPing"
                                   Size="Size.Large">
                            Jump to Latest Ping
                        </MudButton>
                    </div>
                }

                <!-- Navigation Route Panel (floating, bottom-left) - shown when a route is calculated -->
                @if (currentRoute != null)
                {
                    <div style="position: absolute; bottom: 16px; left: 16px; z-index: 1400; max-width: 320px;">
                        <NavigationPanel IsVisible="true"
                                        Route="@currentRoute"
                                        OnClearRoute="@HandleClearRoute"
                                        OnJumpToRoad="@HandleJumpToRouteRoad" />
                    </div>
                }

                <!-- Map Controls Hint (floating, bottom-right, collapsible) -->
                @if (hasMarkersPermission)
                {
                    <MudPaper Elevation="2"
                              Style="@GetControlsHintStyle()"
                              Class="controls-hint">
                        <MudExpansionPanels @bind-Expanded="@controlsHintExpanded" Elevation="0" DisableGutters="true">
                            <MudExpansionPanel Text="Map Controls" Dense="true">
                                <TitleContent>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" />
                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">Map Controls</MudText>
                                    </MudStack>
                                </TitleContent>
                                <ChildContent>
                                    <MudStack Spacing="1" Class="pa-2">
                                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                            <MudIcon Icon="@Icons.Material.Filled.TouchApp" Size="Size.Small" />
                                            <MudText Typo="Typo.body2">Right-click map to ping or create marker</MudText>
                                        </MudStack>
                                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                            <MudIcon Icon="@Icons.Material.Filled.Timer" Size="Size.Small" />
                                            <MudText Typo="Typo.body2">Right-click markers to set timers</MudText>
                                        </MudStack>
                                    </MudStack>
                                </ChildContent>
                            </MudExpansionPanel>
                        </MudExpansionPanels>
                    </MudPaper>
                }

                <!-- Fullscreen Map View -->
                <div class="map-view-container-fullscreen @(isSidebarOpen ? "sidebar-open" : "")" @onclick="@HandleMapClick">
                    <MapView @ref="mapView"
                             State="@state"
                             OnMapDragged="@HandleMapDragged"
                             OnMapZoomed="@HandleMapZoomed"
                             OnContextMenu="@HandleContextMenu"
                             OnMarkerClicked="@HandleMarkerClicked"
                             OnMarkerContextMenu="@HandleMarkerContextMenu"
                             OnCustomMarkerContextMenu="@HandleCustomMarkerContextMenu"
                             OnMapRightClick="@HandleMapRightClick"
                             OnMapInitialized="@HandleMapInitialized"
                             OnMapChanged="@HandleMapChanged"
                             OnRequestOverlays="@HandleRequestOverlays"
                             OnRoadDrawingComplete="@HandleRoadDrawingComplete"
                             OnRoadContextMenu="@HandleRoadContextMenu" />
                </div>
            </MudMainContent>
        </MudDrawerContainer>

        <!-- Tile Context Menu (admin/writer only) -->
        @if (state.Permissions.Contains("admin") || state.Permissions.Contains(Permission.Writer.ToClaimValue()))
        {
            <TileContextMenu Visible="@showContextMenu"
                             Left="@contextMenuX"
                             Top="@contextMenuY"
                             Grid="@contextCoords"
                             OnWipeTile="@HandleWipeTile"
                             OnSetCoords="@HandleSetCoords" />
        }

        <!-- Marker Context Menu -->
        <MarkerContextMenu Visible="@showMarkerContextMenu"
                           Left="@contextMenuX"
                           Top="@contextMenuY"
                           MarkerId="@contextMarkerId"
                           HasTimer="@markerHasTimer"
                           OnSetTimer="@(() => HandleSetTimerForMarker(contextMarkerId))"
                           OnPing="@(() => HandlePingMarker(contextMarkerId))" />

        <!-- Custom Marker Context Menu -->
        @if (hasMarkersPermission)
        {
            <CustomMarkerContextMenu Visible="@showCustomMarkerContextMenu"
                                     Left="@contextMenuX"
                                     Top="@contextMenuY"
                                     CustomMarkerId="@contextCustomMarkerId"
                                     HasTimer="@customMarkerHasTimer"
                                     OnSetTimer="@(() => HandleSetTimerForCustomMarker(contextCustomMarkerId))"
                                     OnPing="@(() => HandlePingCustomMarker(contextCustomMarkerId))"
                                     OnEdit="@(() => HandleEditCustomMarker(contextCustomMarkerId))"
                                     OnDelete="@(() => HandleDeleteCustomMarker(contextCustomMarkerId))" />
        }

        <!-- Map Action Context Menu (for Create Marker/Ping/Draw Road OR Drawing Mode options) -->
        @if (showMapActionMenu && hasMarkersPermission)
        {
            <MudPaper Class="context-menu" Style="@($"position: fixed; left: {contextMenuX}px; top: {contextMenuY}px; z-index: 2000;")" Elevation="8">
                @if (isDrawingRoad)
                {
                    <!-- Drawing Mode Menu -->
                    <MudList Clickable="true" Dense="true" T="string">
                        <MudListItem OnClick="@HandleFinishRoadFromMenu" T="string" Disabled="@(drawingPointsCount < 2)">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="@(drawingPointsCount >= 2 ? Color.Success : Color.Default)" />
                                <MudText>Finish Road (@drawingPointsCount points)</MudText>
                            </MudStack>
                        </MudListItem>
                        <MudListItem OnClick="@HandleCancelRoadFromMenu" T="string">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" Color="Color.Error" />
                                <MudText>Cancel Drawing</MudText>
                            </MudStack>
                        </MudListItem>
                    </MudList>
                }
                else
                {
                    <!-- Normal Menu -->
                    <MudList Clickable="true" Dense="true" T="string">
                        <MudListItem OnClick="@HandleCreateCustomMarkerFromMenu" T="string">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.AddLocation" Size="Size.Small" Color="Color.Success" />
                                <MudText>Create Custom Marker</MudText>
                            </MudStack>
                        </MudListItem>
                        <MudListItem OnClick="@HandleCreatePingFromMenu" T="string">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.LocationSearching" Size="Size.Small" Color="Color.Error" />
                                <MudText>Ping (60s)</MudText>
                            </MudStack>
                        </MudListItem>
                        <MudDivider />
                        <MudListItem OnClick="@HandleStartDrawRoadFromMenu" T="string">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Timeline" Size="Size.Small" Color="Color.Warning" />
                                <MudText>Draw Road</MudText>
                            </MudStack>
                        </MudListItem>
                        @if (allRoads.Count > 0)
                        {
                            <MudDivider />
                            <MudListItem OnClick="@HandleNavigateHereFromMenu" T="string">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Navigation" Size="Size.Small" Color="Color.Info" />
                                    <MudText>Navigate Here</MudText>
                                </MudStack>
                            </MudListItem>
                        }
                        @if (isTenantAdmin)
                        {
                            <MudDivider />
                            <MudListItem OnClick="@HandleDeleteTileFromMenu" T="string">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" />
                                    <MudText>Delete Tile (@mapActionCoordX, @mapActionCoordY)</MudText>
                                </MudStack>
                            </MudListItem>
                        }
                        <MudDivider />
                        <MudListItem OnClick="@HandleShowTileInfo" T="string">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" />
                                <MudText>Tile Info</MudText>
                            </MudStack>
                        </MudListItem>
                    </MudList>
                }
            </MudPaper>
        }

        <!-- Road Context Menu -->
        @if (showRoadContextMenu && hasMarkersPermission)
        {
            <RoadContextMenu Visible="@showRoadContextMenu"
                             Left="@contextMenuX"
                             Top="@contextMenuY"
                             RoadId="@contextRoadId"
                             CanEdit="@contextRoadCanEdit"
                             OnJumpTo="@(() => HandleJumpToRoad(contextRoadId))"
                             OnEdit="@(() => HandleEditRoad(contextRoadId))"
                             OnDelete="@(() => HandleDeleteRoad(contextRoadId))" />
        }
    }

    <!-- Tile Info Dialog -->
    <MudDialog @bind-Visible="showTileInfoDialog" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium })">
        <TitleContent>
            <MudText Typo="Typo.h6">Tile Info</MudText>
        </TitleContent>
        <DialogContent>
            @if (tileInfoLoading)
            {
                <MudStack AlignItems="AlignItems.Center">
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                    <MudText Typo="Typo.body2">Loading...</MudText>
                </MudStack>
            }
            else if (tileInfoResult != null)
            {
                <MudSimpleTable Dense="true" Hover="true" Style="overflow-x: auto;">
                    <tbody>
                        <tr>
                            <td><strong>Coordinates</strong></td>
                            <td>(@tileInfoResult.X, @tileInfoResult.Y)</td>
                        </tr>
                        <tr>
                            <td><strong>Map ID</strong></td>
                            <td>@tileInfoResult.MapId</td>
                        </tr>
                        <tr>
                            <td><strong>Grid ID</strong></td>
                            <td>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <code style="font-size: 0.85em; word-break: break-all;">@tileInfoResult.GridId</code>
                                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small"
                                                   OnClick="@(() => CopyToClipboard(tileInfoResult.GridId))"
                                                   Title="Copy to clipboard" />
                                </MudStack>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Next Update</strong></td>
                            <td>@tileInfoResult.NextUpdate.ToString("yyyy-MM-dd HH:mm:ss UTC")</td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            }
            else
            {
                <MudAlert Severity="Severity.Warning" Dense="true">
                    No tile data at this location (@mapActionCoordX, @mapActionCoordY)
                </MudAlert>
            }
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="@(() => showTileInfoDialog = false)">Close</MudButton>
        </DialogActions>
    </MudDialog>
</div>
