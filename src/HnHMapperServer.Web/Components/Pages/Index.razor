@page "/"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using HnHMapperServer.Core.Constants
@using HnHMapperServer.Web.Components.Shared
@using HnHMapperServer.Web.Services
@using HnHMapperServer.Core.Enums
@using HnHMapperServer.Core.Extensions
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject HnHMapperServer.Web.Services.UserService UserService
@inject TenantContextService TenantContext
@inject ITenantService TenantService
@inject IJSRuntime JS
@using HnHMapperServer.Web.Models
@using Microsoft.AspNetCore.Authentication.Cookies
@using Microsoft.AspNetCore.Authentication

<PageTitle>HnH Mapper Dashboard</PageTitle>

<MudContainer Class="mt-6">
    <AuthorizeView>
        <Authorized>
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
            <MudPaper Class="pa-4 mb-4 glass-morphism" Elevation="0">
                <MudText Typo="Typo.h3">
                    Welcome, @context.User.Identity?.Name!
                </MudText>
            </MudPaper>

            @* Tenant Context Header *@
            @if (_currentTenant != null)
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mb-4 glass-morphism">
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <strong>Current Organization:</strong> @_currentTenant.Name
                            <MudChip T="string" Size="Size.Small" Color="@GetRoleColor(_currentTenant.Role)" Class="ml-2">@_currentTenant.Role</MudChip>
                        </div>
                        @if (_userHasMultipleTenants)
                        {
                            <MudButton Variant="Variant.Text"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       Href="/tenant/select">
                                Switch Organization
                            </MudButton>
                        }
                    </div>
                </MudAlert>

                @* Storage Usage Gauge *@
                <StorageUsageGauge CurrentUsageMB="@_currentTenant.StorageUsageMB"
                                   QuotaMB="@_currentTenant.StorageQuotaMB" />
            }


            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudPaper Elevation="0" Class="pa-6 glass-morphism">
                        <MudText Typo="Typo.h5" Class="mb-4">
                            <MudIcon Icon="@Icons.Material.Filled.Key" Class="me-2" />
                            Your Tokens
                        </MudText>

                        <MudTable Items="@tokens" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@isLoading">
                            <HeaderContent>
                                <MudTh>Token URL</MudTh>
                                <MudTh>Permissions</MudTh>
                                <MudTh>Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate Context="token">
                                <MudTd DataLabel="Token URL">
                                    <MudText Typo="Typo.caption" Style="font-family: monospace; word-break: break-all;">@token.Url</MudText>
                                </MudTd>
                                <MudTd DataLabel="Permissions">
                                    @string.Join(", ", token.Permissions)
                                </MudTd>
                                <MudTd DataLabel="Actions">
                                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small" Color="Color.Primary"
                                                   OnClick="@(() => CopyToClipboard(token.Url))" Title="Copy URL to clipboard" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>

                        @if (hasUploadPermission)
                        {
                            <MudButton
                                Variant="Variant.Filled"
                                Color="Color.Primary"
                                Class="mt-4"
                                OnClick="GenerateToken"
                                Disabled="@isLoading">
                                <MudIcon Icon="@Icons.Material.Filled.Add" Class="me-2" />
                                Generate New Token
                            </MudButton>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Class="mt-4 glass-morphism" Dense="true">
                                You need Upload permission to generate tokens. Contact an administrator.
                            </MudAlert>
                        }
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudPaper Elevation="0" Class="pa-6 mb-4 glass-morphism">
                        <MudText Typo="Typo.h5" Class="mb-4">
                            <MudIcon Icon="@Icons.Material.Filled.Settings" Class="me-2" />
                            Quick Actions
                        </MudText>

                        <MudStack Spacing="3">
                            <MudButton
                                Variant="Variant.Outlined"
                                Color="Color.Primary"
                                FullWidth="true"
                                Href="/password">
                                <MudIcon Icon="@Icons.Material.Filled.Lock" Class="me-2" />
                                Change Password
                            </MudButton>

                            <MudButton
                                Variant="Variant.Outlined"
                                Color="Color.Info"
                                FullWidth="true"
                                Href="/map">
                                <MudIcon Icon="@Icons.Material.Filled.Map" Class="me-2" />
                                View Map
                            </MudButton>

                            @if (context.User.IsInRole("SuperAdmin"))
                            {
                                <MudButton
                                    Variant="Variant.Outlined"
                                    Color="Color.Error"
                                    FullWidth="true"
                                    Href="/superadmin">
                                    <MudIcon Icon="@Icons.Material.Filled.SupervisorAccount" Class="me-2" />
                                    SuperAdmin Panel
                                </MudButton>
                            }

                            @if (context.User.IsInRole("TenantAdmin"))
                            {
                                <MudButton
                                    Variant="Variant.Outlined"
                                    Color="Color.Secondary"
                                    FullWidth="true"
                                    Href="/admin">
                                    <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Class="me-2" />
                                    Organization Admin
                                </MudButton>
                            }

                            <MudButton
                                Variant="Variant.Outlined"
                                Color="Color.Error"
                                FullWidth="true"
                                OnClick="HandleLogout">
                                <MudIcon Icon="@Icons.Material.Filled.Logout" Class="me-2" />
                                Logout
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudContainer>
        </Authorized>
    </AuthorizeView>
</MudContainer>

@code {
    private List<UserTokenDto> tokens = new();
    private bool isLoading = true;
    private bool hasUploadPermission = false;
    private TenantDto? _currentTenant;
    private bool _userHasMultipleTenants;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("API");
            using var resp = await client.GetAsync("/api/auth/me");
            if (!resp.IsSuccessStatusCode)
            {
                Snackbar.Add($"Auth check failed: {(int)resp.StatusCode}", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Auth check error: {ex.Message}", Severity.Warning);
        }

        // Load tenant information
        try
        {
            var tenants = await TenantContext.GetTenantsAsync();
            _userHasMultipleTenants = tenants.Count > 1;

            // Get current tenant from context or use first tenant if only one
            _currentTenant = TenantContext.CurrentTenant ?? tenants.FirstOrDefault();
            if (_currentTenant != null && TenantContext.CurrentTenant == null)
            {
                TenantContext.SetCurrentTenant(_currentTenant);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading tenant info: {ex.Message}", Severity.Warning);
        }

        // [Authorize] attribute handles authentication - just load data
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();

        // Check for upload permission OR admin role
        var hasUpload = authState.User.Claims.Any(c =>
            c.Type == AuthorizationConstants.ClaimTypes.TenantPermission &&
            c.Value.Equals(Permission.Upload.ToClaimValue(), StringComparison.OrdinalIgnoreCase));

        var isAdmin = authState.User.Claims.Any(c =>
            c.Type == System.Security.Claims.ClaimTypes.Role &&
            (c.Value == "admin" || c.Value == "Admin"));

        hasUploadPermission = hasUpload || isAdmin;

        await LoadTokens();
    }

    private Color GetRoleColor(string role)
    {
        return role.ToLower() switch
        {
            "superadmin" => Color.Error,
            "tenantadmin" => Color.Primary,
            "tenantuser" => Color.Default,
            _ => Color.Default
        };
    }

    private async Task LoadTokens()
    {
        isLoading = true;
        try
        {
            tokens = await UserService.GetUserTokensAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading tokens: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GenerateToken()
    {
        isLoading = true;
        try
        {
            var result = await UserService.GenerateTokenAsync();
            if (result != null && result.Success)
            {
                Snackbar.Add("Token generated successfully!", Severity.Success);
                await LoadTokens(); // Reload tokens to show the new one
            }
            else
            {
                Snackbar.Add(result?.Message ?? "Failed to generate token", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error generating token: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
            Snackbar.Add("Copied to clipboard!", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Failed to copy to clipboard", Severity.Warning);
        }
    }

    private void HandleLogout()
    {
        // Navigate to logout endpoint which will sign out and redirect to login
        NavigationManager.NavigateTo("/api/logout", forceLoad: true);
    }
}
