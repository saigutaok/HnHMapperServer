@page "/password"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Change Password</PageTitle>

<div class="auth-page">
<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
        <MudPaper Elevation="0" Class="pa-8">
            <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-6">
                Change Password
            </MudText>

            <EditForm Model="@model" OnValidSubmit="HandlePasswordChange" FormName="PasswordForm">
                <DataAnnotationsValidator />

                <MudTextField
                    @bind-Value="model.NewPassword"
                    Label="New Password"
                    Variant="Variant.Outlined"
                    InputType="InputType.Password"
                    Margin="Margin.Dense"
                    Class="mb-4"
                    Required="true"
                    Disabled="@isLoading" />

                <MudTextField
                    @bind-Value="model.ConfirmPassword"
                    Label="Confirm New Password"
                    Variant="Variant.Outlined"
                    InputType="InputType.Password"
                    Margin="Margin.Dense"
                    Class="mb-6"
                    Required="true"
                    Disabled="@isLoading" />

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4">
                        @errorMessage
                    </MudAlert>
                }

                <MudStack Row="true" Spacing="3">
                    <MudButton
                        ButtonType="ButtonType.Submit"
                        Variant="Variant.Filled"
                        Color="Color.Primary"
                        FullWidth="true"
                        Disabled="@isLoading">
                        @if (isLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Changing...</MudText>
                        }
                        else
                        {
                            <MudText>Change Password</MudText>
                        }
                    </MudButton>

                    <MudButton
                        Variant="Variant.Outlined"
                        Color="Color.Default"
                        FullWidth="true"
                        Href="/"
                        Disabled="@isLoading">
                        Cancel
                    </MudButton>
                </MudStack>
            </EditForm>
        </MudPaper>
</MudContainer>
</div>

@code {
    [SupplyParameterFromForm]
    private PasswordModel model { get; set; } = new();

    private bool isLoading = false;
    private string? errorMessage;

    private async Task HandlePasswordChange()
    {
        errorMessage = null;

        if (string.IsNullOrWhiteSpace(model.NewPassword))
        {
            errorMessage = "Password cannot be empty";
            return;
        }

        if (model.NewPassword != model.ConfirmPassword)
        {
            errorMessage = "Passwords do not match";
            return;
        }

        if (model.NewPassword.Length < 6)
        {
            errorMessage = "Password must be at least 6 characters long";
            return;
        }

        isLoading = true;

        try
        {
            // TODO: Call API to change password when endpoint is ready
            var httpClient = HttpClientFactory.CreateClient("API");
            var content = new FormUrlEncodedContent(new[]
            {
                new KeyValuePair<string, string>("newpassword", model.NewPassword)
            });

            var response = await httpClient.PostAsync("/password", content);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Password changed successfully!", Severity.Success);
                NavigationManager.NavigateTo("/");
            }
            else
            {
                errorMessage = "Failed to change password";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private class PasswordModel
    {
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
