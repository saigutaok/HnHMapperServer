@page "/admin"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "TenantAdmin")]
@using HnHMapperServer.Web.Components.Admin
@using HnHMapperServer.Web.Components.SuperAdmin
@using HnHMapperServer.Web.Models
@using HnHMapperServer.Web.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject TenantContextService TenantContext
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Admin Panel - HnH Mapper</PageTitle>
<div class="admin-panel">
<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h3" Class="mb-6">
        <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Class="me-2" />
        Admin Panel
    </MudText>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        @* User Management Tab *@
        <MudTabPanel Text="Users" Icon="@Icons.Material.Filled.People">
            <UserManagement />
        </MudTabPanel>

        @* Token Management Tab *@
        <MudTabPanel Text="Tokens" Icon="@Icons.Material.Filled.Key">
            <TokenManagement />
        </MudTabPanel>

        @* Invitation Management Tab *@
        <MudTabPanel Text="Invitations" Icon="@Icons.Material.Filled.Mail">
            <InvitationManagement />
        </MudTabPanel>

        @* Pending User Approvals Tab *@
        <MudTabPanel Text="Pending Users" Icon="@Icons.Material.Filled.HowToReg">
            <PendingUsers />
        </MudTabPanel>

        @* Tenant Settings Tab *@
        <MudTabPanel Text="Settings" Icon="@Icons.Material.Filled.Settings">
            <TenantSettings />
        </MudTabPanel>

        @* Map Management Tab *@
        <MudTabPanel Text="Maps" Icon="@Icons.Material.Filled.Map">
            <MapManagement />
        </MudTabPanel>
    </MudTabs>

    <MudButton Variant="Variant.Text" Color="Color.Default" Href="/" Class="mt-4" StartIcon="@Icons.Material.Filled.ArrowBack">
        Back to Dashboard
    </MudButton>
</MudContainer>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        // Fetch user's tenants and set current tenant
        var tenants = await TenantContext.GetTenantsAsync();

        if (tenants.Count > 0 && TenantContext.CurrentTenant == null)
        {
            // Get TenantId from claims to find the right tenant
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var claimTenantId = authState.User.FindFirst(
                HnHMapperServer.Core.Constants.AuthorizationConstants.ClaimTypes.TenantId)?.Value;

            var matchingTenant = tenants.FirstOrDefault(t => t.Id == claimTenantId)
                              ?? tenants.First();
            TenantContext.SetCurrentTenant(matchingTenant);
        }
    }
}
