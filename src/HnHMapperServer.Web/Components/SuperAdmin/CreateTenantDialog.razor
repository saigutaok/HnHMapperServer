@using HnHMapperServer.Core.DTOs
@using MudBlazor
@inject IHttpClientFactory HttpClientFactory
@inject ISnackbar Snackbar
@inject ILogger<CreateTenantDialog> Logger

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-4">Create New Tenant</MudText>

        <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
            <MudText Typo="Typo.body2">
                A unique tenant ID will be automatically generated in the format:
                <strong>icon1-icon2-number</strong> (e.g., "warrior-shield-42")
            </MudText>
            <MudText Typo="Typo.body2" Class="mt-1">
                The tenant name will initially be set to the same as the ID and can be changed later.
            </MudText>
        </MudAlert>

        <MudStack Spacing="3">
            <MudNumericField @bind-Value="_storageQuotaMB"
                             Label="Storage Quota (MB)"
                             Variant="Variant.Outlined"
                             Min="100"
                             Step="100"
                             Required="true"
                             HelperText="Maximum storage allowed in megabytes (default: 1024 MB = 1 GB)"
                             Adornment="Adornment.End"
                             AdornmentText="MB" />

            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Storage quota can be adjusted later from the tenant details page.
            </MudText>
        </MudStack>

        @if (_errorMessage != null)
        {
            <MudAlert Severity="Severity.Error" Dense="true" Class="mt-3">
                @_errorMessage
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Disabled="@_isCreating">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="CreateTenant"
                   Disabled="@(_isCreating || _storageQuotaMB < 100)">
            @if (_isCreating)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Creating...</MudText>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.Add" Class="me-1" />
                <MudText>Create Tenant</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance? MudDialog { get; set; }

    private int _storageQuotaMB = 1024; // Default 1 GB
    private bool _isCreating = false;
    private string? _errorMessage = null;

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private async Task CreateTenant()
    {
        if (_storageQuotaMB < 100)
        {
            Snackbar.Add("Storage quota must be at least 100 MB", Severity.Error);
            return;
        }

        _isCreating = true;
        _errorMessage = null;

        try
        {
            var httpClient = HttpClientFactory.CreateClient("API");
            var request = new
            {
                storageQuotaMB = _storageQuotaMB
            };

            var response = await httpClient.PostAsJsonAsync(
                "/api/superadmin/tenants",
                request);

            if (response.IsSuccessStatusCode)
            {
                var createdTenant = await response.Content.ReadFromJsonAsync<TenantDto>(
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                if (createdTenant != null)
                {
                    Snackbar.Add($"Tenant '{createdTenant.Id}' created successfully", Severity.Success);
                    MudDialog?.Close(DialogResult.Ok(createdTenant));
                }
                else
                {
                    Snackbar.Add("Tenant created successfully", Severity.Success);
                    MudDialog?.Close(DialogResult.Ok(true));
                }
            }
            else
            {
                var errorBody = await response.Content.ReadAsStringAsync();
                Logger.LogWarning("Failed to create tenant: {StatusCode}, Body={Body}", response.StatusCode, errorBody);

                // Try to parse error message
                try
                {
                    var errorObj = System.Text.Json.JsonSerializer.Deserialize<ErrorResponse>(errorBody,
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    _errorMessage = errorObj?.Error ?? $"Failed to create tenant: {response.StatusCode}";
                }
                catch
                {
                    _errorMessage = $"Failed to create tenant: {response.StatusCode}";
                }

                Snackbar.Add(_errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating tenant");
            _errorMessage = $"Error creating tenant: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _isCreating = false;
        }
    }

    private class TenantDto
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
    }

    private class ErrorResponse
    {
        public string Error { get; set; } = string.Empty;
    }
}
