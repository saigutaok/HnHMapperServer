@using HnHMapperServer.Web.Models
@using HnHMapperServer.Web.Services
@using HnHMapperServer.Core.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@inject TenantContextService TenantContext
@inject IHttpClientFactory HttpClientFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISnackbar Snackbar
@inject ILogger<TenantAuditLogs> Logger

<MudPaper Class="pa-4">
    <MudStack Spacing="3">
        <div class="d-flex justify-space-between align-center">
            <MudText Typo="Typo.h5">
                <MudIcon Icon="@Icons.Material.Filled.History" Class="me-2" />
                Audit Logs
            </MudText>
            <MudButton Variant="Variant.Filled"
                      Color="Color.Primary"
                      StartIcon="@Icons.Material.Filled.Refresh"
                      OnClick="LoadAuditLogs"
                      Disabled="@_isLoading">
                Refresh
            </MudButton>
        </div>

        @* Filters *@
        <MudPaper Elevation="2" Class="pa-3">
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudTextField @bind-Value="_filterUser"
                                 Label="Filter by User"
                                 Variant="Variant.Outlined"
                                 Clearable="true"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Person" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudSelect @bind-Value="_filterAction"
                              Label="Filter by Action"
                              Variant="Variant.Outlined"
                              Clearable="true"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.FilterList">
                        <MudSelectItem Value="@("All")">All Actions</MudSelectItem>
                        <MudSelectItem Value="@("UserApproved")">User Approved</MudSelectItem>
                        <MudSelectItem Value="@("UserRejected")">User Rejected</MudSelectItem>
                        <MudSelectItem Value="@("PermissionsUpdated")">Permissions Updated</MudSelectItem>
                        <MudSelectItem Value="@("UserRemoved")">User Removed</MudSelectItem>
                        <MudSelectItem Value="@("InvitationCreated")">Invitation Created</MudSelectItem>
                        <MudSelectItem Value="@("InvitationRevoked")">Invitation Revoked</MudSelectItem>
                        <MudSelectItem Value="@("TokenCreated")">Token Created</MudSelectItem>
                        <MudSelectItem Value="@("TokenRevoked")">Token Revoked</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Secondary"
                              OnClick="ApplyFilters"
                              Disabled="@_isLoading"
                              FullWidth="true">
                        Apply Filters
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>

        @if (_isLoading)
        {
            <MudProgressLinear Indeterminate="true" />
        }
        else if (_hasError)
        {
            <MudAlert Severity="Severity.Error">
                Failed to load audit logs. Please check the logs or contact support.
            </MudAlert>
        }
        else if (!_auditLogs.Any())
        {
            <MudAlert Severity="Severity.Info">
                No audit logs found for this organization.
            </MudAlert>
        }
        else
        {
            <MudTable Items="@_filteredLogs" Hover="true" Dense="true" FixedHeader="true" Height="600px">
                <HeaderContent>
                    <MudTh>Timestamp</MudTh>
                    <MudTh>User</MudTh>
                    <MudTh>Action</MudTh>
                    <MudTh>Entity</MudTh>
                    <MudTh>Details</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Timestamp">
                        <MudText Typo="Typo.body2">@context.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                    </MudTd>
                    <MudTd DataLabel="User">
                        <MudText Typo="Typo.body2">@context.Username</MudText>
                    </MudTd>
                    <MudTd DataLabel="Action">
                        <MudChip T="string" Size="Size.Small" Color="@GetActionColor(context.Action)">
                            @context.Action
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Entity">
                        <MudText Typo="Typo.body2">
                            @context.EntityType
                            @if (!string.IsNullOrEmpty(context.EntityId))
                            {
                                <code class="ms-1">@context.EntityId</code>
                            }
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Details">
                        @if (!string.IsNullOrEmpty(context.OldValue) || !string.IsNullOrEmpty(context.NewValue))
                        {
                            <MudTooltip Text="@GetChangeDetails(context)">
                                <MudIconButton Icon="@Icons.Material.Filled.Info" Size="Size.Small" Color="Color.Info" />
                            </MudTooltip>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">-</MudText>
                        }
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 25, 50, 100 }" />
                </PagerContent>
            </MudTable>
        }
    </MudStack>
</MudPaper>

@code {
    private List<AuditLogDto> _auditLogs = new();
    private List<AuditLogDto> _filteredLogs = new();
    private bool _isLoading = true;
    private bool _hasError = false;

    private string? _filterUser;
    private string _filterAction = "All";

    protected override async Task OnInitializedAsync()
    {
        await LoadAuditLogs();
    }

    private async Task LoadAuditLogs()
    {
        _isLoading = true;
        _hasError = false;
        try
        {
            var tenantId = TenantContext.CurrentTenant?.Id;
            if (string.IsNullOrEmpty(tenantId))
            {
                // Fallback to fetching tenants
                var tenants = await TenantContext.GetTenantsAsync();
                tenantId = tenants.FirstOrDefault()?.Id;
            }

            // Fall back to getting TenantId from user claims
            if (string.IsNullOrEmpty(tenantId))
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                tenantId = authState.User.FindFirst(HnHMapperServer.Core.Constants.AuthorizationConstants.ClaimTypes.TenantId)?.Value;

                Logger.LogInformation("Got tenant ID from claims: {TenantId}", tenantId);
            }

            if (string.IsNullOrEmpty(tenantId))
            {
                Snackbar.Add("Unable to determine your tenant. Please contact support.", Severity.Error);
                Logger.LogError("Unable to determine tenant ID for user");
                _hasError = true;
                return;
            }

            var httpClient = HttpClientFactory.CreateClient("API");
            var response = await httpClient.GetAsync($"/api/tenants/{tenantId}/audit-logs");

            if (response.IsSuccessStatusCode)
            {
                _auditLogs = await response.Content.ReadFromJsonAsync<List<AuditLogDto>>() ?? new List<AuditLogDto>();
                ApplyFilters();
                StateHasChanged(); // Ensure UI updates after filtering
                Logger.LogInformation("Loaded {Count} audit logs", _auditLogs.Count);
            }
            else
            {
                _hasError = true;
                var errorBody = await response.Content.ReadAsStringAsync();
                Logger.LogWarning("Failed to load audit logs: {StatusCode}, Body={Body}", response.StatusCode, errorBody);
                Snackbar.Add("Failed to load audit logs. The endpoint may not be implemented yet.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            _hasError = true;
            Logger.LogError(ex, "Error loading audit logs");
            Snackbar.Add("Failed to load audit logs. Please try again.", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged(); // Ensure UI updates after loading completes
        }
    }

    private void ApplyFilters()
    {
        var filteredLogs = _auditLogs.AsEnumerable();

        // Filter by user
        if (!string.IsNullOrWhiteSpace(_filterUser))
        {
            filteredLogs = filteredLogs
                .Where(log => log.Username?.Contains(_filterUser, StringComparison.OrdinalIgnoreCase) == true);
        }

        // Filter by action
        if (!string.IsNullOrEmpty(_filterAction) && _filterAction != "All")
        {
            filteredLogs = filteredLogs
                .Where(log => log.Action == _filterAction);
        }

        _filteredLogs = filteredLogs.ToList();
        StateHasChanged(); // Ensure UI updates after filtering
    }

    private Color GetActionColor(string action)
    {
        return action switch
        {
            "UserApproved" or "InvitationCreated" or "TokenCreated" => Color.Success,
            "UserRejected" or "UserRemoved" or "InvitationRevoked" or "TokenRevoked" => Color.Error,
            "PermissionsUpdated" => Color.Info,
            _ => Color.Default
        };
    }

    private string GetChangeDetails(AuditLogDto log)
    {
        if (!string.IsNullOrEmpty(log.OldValue) && !string.IsNullOrEmpty(log.NewValue))
        {
            return $"Changed from: {log.OldValue}\nChanged to: {log.NewValue}";
        }
        else if (!string.IsNullOrEmpty(log.NewValue))
        {
            return $"Set to: {log.NewValue}";
        }
        else if (!string.IsNullOrEmpty(log.OldValue))
        {
            return $"Previous value: {log.OldValue}";
        }
        return "No details available";
    }
}
