@using System.Net.Http.Json
@using HnHMapperServer.Core.DTOs
@using MudBlazor
@inject IHttpClientFactory HttpClientFactory
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_isValid">
            <MudStack Spacing="3">
                @if (Timer == null && string.IsNullOrEmpty(PresetType) && !ForceStandalone)
                {
                    <!-- Timer Type Selection (only shown when creating new timer, not from marker) -->
                    <MudRadioGroup @bind-SelectedOption="_timerType" T="string">
                        <MudRadio T="string" Option="@("Standalone")" Color="Color.Primary">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" />
                                <div>
                                    <MudText Typo="Typo.body2">Standalone Event</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Generic timer not attached to a marker</MudText>
                                </div>
                            </MudStack>
                        </MudRadio>
                        <MudRadio T="string" Option="@("Marker")" Color="Color.Primary" Disabled="@(_availableMarkers.Count == 0)">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Place" Size="Size.Small" />
                                <div>
                                    <MudText Typo="Typo.body2">Resource Marker</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Attach to a resource marker on the map</MudText>
                                </div>
                            </MudStack>
                        </MudRadio>
                        <MudRadio T="string" Option="@("CustomMarker")" Color="Color.Primary" Disabled="@(_availableCustomMarkers.Count == 0)">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.AddLocation" Size="Size.Small" />
                                <div>
                                    <MudText Typo="Typo.body2">Custom Marker</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Attach to a custom marker you created</MudText>
                                </div>
                            </MudStack>
                        </MudRadio>
                    </MudRadioGroup>

                    <!-- Marker Selection (if Marker type) -->
                    @if (_timerType == "Marker" && _availableMarkers.Any())
                    {
                        <MudSelect @bind-Value="_selectedMarkerId"
                                   Label="Select Marker"
                                   Variant="Variant.Outlined"
                                   Required="true">
                            @foreach (var marker in _availableMarkers)
                            {
                                <MudSelectItem Value="@marker.Id">@marker.Name</MudSelectItem>
                            }
                        </MudSelect>
                    }

                    <!-- Custom Marker Selection (if CustomMarker type) -->
                    @if (_timerType == "CustomMarker" && _availableCustomMarkers.Any())
                    {
                        <MudSelect @bind-Value="_selectedCustomMarkerId"
                                   Label="Select Custom Marker"
                                   Variant="Variant.Outlined"
                                   Required="true">
                            @foreach (var marker in _availableCustomMarkers)
                            {
                                <MudSelectItem Value="@marker.Id">@marker.Title</MudSelectItem>
                            }
                        </MudSelect>
                    }
                }
                else if (!string.IsNullOrEmpty(PresetType) || ForceStandalone)
                {
                    <!-- Show info about preset marker (when opened from marker button) -->
                    <MudAlert Severity="Severity.Info" Dense="true">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            @if (_timerType == "Marker")
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Place" Size="Size.Small" />
                                <MudText Typo="Typo.body2">Creating timer for resource marker</MudText>
                            }
                            else if (_timerType == "CustomMarker")
                            {
                                <MudIcon Icon="@Icons.Material.Filled.AddLocation" Size="Size.Small" />
                                <MudText Typo="Typo.body2">Creating timer for custom marker</MudText>
                            }
                            else if (_timerType == "Standalone")
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" />
                                <MudText Typo="Typo.body2">Creating standalone timer</MudText>
                            }
                        </MudStack>
                    </MudAlert>
                }
                else if (Timer != null)
                {
                    <!-- Show info about existing timer type (when editing) -->
                    <MudAlert Severity="Severity.Info" Dense="true">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            @if (_timerType == "Marker")
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Place" Size="Size.Small" />
                                <MudText Typo="Typo.body2">Editing timer for resource marker</MudText>
                            }
                            else if (_timerType == "CustomMarker")
                            {
                                <MudIcon Icon="@Icons.Material.Filled.AddLocation" Size="Size.Small" />
                                <MudText Typo="Typo.body2">Editing timer for custom marker</MudText>
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" />
                                <MudText Typo="Typo.body2">Editing standalone timer</MudText>
                            }
                        </MudStack>
                    </MudAlert>
                }

                <!-- Title -->
                <MudTextField @bind-Value="_title"
                              Label="Title"
                              Variant="Variant.Outlined"
                              Required="true"
                              RequiredError="Title is required"
                              Immediate="true"
                              MaxLength="200" />

                <!-- Description -->
                <MudTextField @bind-Value="_description"
                              Label="Description (optional)"
                              Variant="Variant.Outlined"
                              Lines="2"
                              MaxLength="500" />

                <!-- Duration Presets -->
                <MudText Typo="Typo.subtitle2">Duration Presets</MudText>
                <MudChipSet T="string" @bind-SelectedChip="_selectedPreset" Filter="false">
                    <MudChip T="string" Text="5 minutes" OnClick="@(() => SetDuration(5, "minutes"))" />
                    <MudChip T="string" Text="15 minutes" OnClick="@(() => SetDuration(15, "minutes"))" />
                    <MudChip T="string" Text="30 minutes" OnClick="@(() => SetDuration(30, "minutes"))" />
                    <MudChip T="string" Text="1 hour" OnClick="@(() => SetDuration(1, "hours"))" />
                    <MudChip T="string" Text="2 hours" OnClick="@(() => SetDuration(2, "hours"))" />
                    <MudChip T="string" Text="4 hours" OnClick="@(() => SetDuration(4, "hours"))" />
                    <MudChip T="string" Text="8 hours" OnClick="@(() => SetDuration(8, "hours"))" />
                    <MudChip T="string" Text="12 hours" OnClick="@(() => SetDuration(12, "hours"))" />
                    <MudChip T="string" Text="1 day" OnClick="@(() => SetDuration(1, "days"))" />
                    <MudChip T="string" Text="2 days" OnClick="@(() => SetDuration(2, "days"))" />
                    <MudChip T="string" Text="3 days" OnClick="@(() => SetDuration(3, "days"))" />
                    <MudChip T="string" Text="1 week" OnClick="@(() => SetDuration(7, "days"))" />
                </MudChipSet>

                <!-- Custom Duration -->
                <MudText Typo="Typo.subtitle2" Class="mt-2">Or Set Custom Duration</MudText>
                <MudStack Row="true" Spacing="2">
                    <MudNumericField @bind-Value="_customDays"
                                     Label="Days"
                                     Variant="Variant.Outlined"
                                     Min="0"
                                     Max="365"
                                     HideSpinButtons="false" />
                    <MudNumericField @bind-Value="_customHours"
                                     Label="Hours"
                                     Variant="Variant.Outlined"
                                     Min="0"
                                     Max="23"
                                     HideSpinButtons="false" />
                    <MudNumericField @bind-Value="_customMinutes"
                                     Label="Minutes"
                                     Variant="Variant.Outlined"
                                     Min="0"
                                     Max="59"
                                     HideSpinButtons="false" />
                </MudStack>

                <!-- Ready At Display -->
                <MudAlert Severity="Severity.Info" Dense="true">
                    Timer will be ready at: <strong>@GetReadyAtTime().ToLocalTime().ToString("g")</strong>
                </MudAlert>
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Disabled="@(!_isValid || _submitting)">
            @if (_submitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
            }
            else
            {
                <text>@(Timer == null ? "Create" : "Update")</text>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public TimerDto? Timer { get; set; }

    [Parameter]
    public string? PresetType { get; set; }

    [Parameter]
    public int? PresetMarkerId { get; set; }

    [Parameter]
    public int? PresetCustomMarkerId { get; set; }

    [Parameter]
    public string? PresetTitle { get; set; }

    [Parameter]
    public bool ForceStandalone { get; set; }

    private MudForm _form = null!;
    private bool _isValid;
    private bool _submitting;

    private string _timerType = "Standalone";
    private int? _selectedMarkerId;
    private int? _selectedCustomMarkerId;
    private string _title = "";
    private string _description = "";

    private int _customDays = 0;
    private int _customHours = 0;
    private int _customMinutes = 5;

    private MudChip<string>? _selectedPreset;

    private List<MarkerSummary> _availableMarkers = new();
    private List<CustomMarkerSummary> _availableCustomMarkers = new();

    protected override async Task OnInitializedAsync()
    {
        // Load available markers (simplified - you'll need proper API endpoints)
        // For now, we'll just use empty lists
        _availableMarkers = new List<MarkerSummary>();
        _availableCustomMarkers = new List<CustomMarkerSummary>();

        // If editing existing timer, populate fields
        if (Timer != null)
        {
            _timerType = Timer.Type ?? "Standalone";
            _selectedMarkerId = Timer.MarkerId;
            _selectedCustomMarkerId = Timer.CustomMarkerId;
            _title = Timer.Title;
            _description = Timer.Description ?? "";

            // Calculate duration from ReadyAt
            var remaining = (Timer.ReadyAt - DateTime.UtcNow);
            if (remaining.TotalMinutes > 0)
            {
                _customDays = (int)remaining.TotalDays;
                _customHours = remaining.Hours;
                _customMinutes = remaining.Minutes;
            }
        }
        // If preset parameters provided (creating timer from marker), pre-fill form
        else if (!string.IsNullOrEmpty(PresetType))
        {
            _timerType = PresetType;
            _selectedMarkerId = PresetMarkerId;
            _selectedCustomMarkerId = PresetCustomMarkerId;
            _title = PresetTitle ?? "";
        }
        // If ForceStandalone is true (creating from sidebar), force type to Standalone
        else if (ForceStandalone)
        {
            _timerType = "Standalone";
        }
    }

    private void SetDuration(int value, string unit)
    {
        switch (unit)
        {
            case "minutes":
                _customDays = 0;
                _customHours = 0;
                _customMinutes = value;
                break;
            case "hours":
                _customDays = 0;
                _customHours = value;
                _customMinutes = 0;
                break;
            case "days":
                _customDays = value;
                _customHours = 0;
                _customMinutes = 0;
                break;
        }
    }

    private DateTime GetReadyAtTime()
    {
        var now = DateTime.UtcNow;
        return now
            .AddDays(_customDays)
            .AddHours(_customHours)
            .AddMinutes(_customMinutes);
    }

    private async Task Submit()
    {
        await _form.Validate();
        if (!_isValid)
            return;

        _submitting = true;

        try
        {
            var readyAt = GetReadyAtTime();

            if (readyAt <= DateTime.UtcNow)
            {
                Snackbar.Add("Timer must be set in the future", Severity.Error);
                _submitting = false;
                return;
            }

            var httpClient = HttpClientFactory.CreateClient("API");

            if (Timer == null)
            {
                // Create new timer
                var createDto = new CreateTimerDto
                {
                    Type = _timerType,
                    MarkerId = _timerType == "Marker" ? _selectedMarkerId : null,
                    CustomMarkerId = _timerType == "CustomMarker" ? _selectedCustomMarkerId : null,
                    Title = _title,
                    Description = string.IsNullOrWhiteSpace(_description) ? null : _description,
                    ReadyAt = readyAt
                };

                await httpClient.PostAsJsonAsync("/api/timers", createDto);
            }
            else
            {
                // Update existing timer
                var updateDto = new UpdateTimerDto
                {
                    Title = _title,
                    Description = string.IsNullOrWhiteSpace(_description) ? null : _description,
                    ReadyAt = readyAt
                };

                await httpClient.PutAsJsonAsync($"/api/timers/{Timer.Id}", updateDto);
            }

            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving timer: {ex.Message}");
            Snackbar.Add($"Failed to save timer: {ex.Message}", Severity.Error);
        }
        finally
        {
            _submitting = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    // Helper classes for marker lists (you'll need to implement proper API endpoints)
    private class MarkerSummary
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
    }

    private class CustomMarkerSummary
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
    }
}
