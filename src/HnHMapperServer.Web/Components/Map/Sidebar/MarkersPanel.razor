@using HnHMapperServer.Web.Models
@using HnHMapperServer.Web.Components.Shared
@using HnHMapperServer.Core.DTOs
@using MudBlazor

<style>
    .marker-group-header {
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 4px;
        background-color: var(--mud-palette-background-gray);
        transition: background-color 0.15s;
    }
    .marker-group-header:hover {
        background-color: var(--mud-palette-action-default-hover);
    }
    .marker-group-content {
        margin-left: 16px;
        margin-bottom: 12px;
        padding-left: 12px;
        border-left: 2px solid var(--mud-palette-primary);
    }
</style>

<!-- Markers panel with filter and list -->
<MudTextField T="string"
              Value="@markerFilter"
              ValueChanged="@OnFilterChanged"
              Placeholder="Filter markers..."
              Adornment="Adornment.Start"
              AdornmentIcon="@Icons.Material.Outlined.Search"
              Variant="Variant.Outlined"
              Margin="Margin.Dense"
              Immediate="true"
              Class="mb-3" />

<!-- Custom Markers Section -->
@if (CustomMarkers.Any())
{
    <MudText Typo="Typo.h6" Class="mb-2 mt-2">
        <MudIcon Icon="@Icons.Material.Filled.AddLocation" Size="Size.Small" Color="Color.Success" Class="mr-1" />
        Custom Markers
    </MudText>
    <MudText Typo="Typo.caption" Class="mb-2">@GetFilteredCustomMarkers().Count() custom marker(s)</MudText>
    <MudList T="string" Dense="true" Clickable="true" Class="mb-4">
        @foreach (var marker in GetFilteredCustomMarkers())
        {
            var customMarkerTimer = GetTimerForCustomMarker(marker.Id);
            <MudListItem T="string" OnClick="@(() => OnCustomMarkerSelected.InvokeAsync(marker))">
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="width: 100%;">
                    <MudStack Row="false" Spacing="0" Style="flex: 1; min-width: 0;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <img src="@GetIconSrc(marker.Icon)"
                                 alt="icon"
                                 style="width: 20px; height: 20px; object-fit: contain;"
                                 onerror="this.onerror=null;this.src='/gfx/terobjs/mm/custom.png';" />
                            <MudText Typo="Typo.body2">@marker.Title</MudText>
                            @if (customMarkerTimer != null)
                            {
                                <TimerBadge Timer="@customMarkerTimer" />
                            }
                        </MudStack>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @GetMapName(marker.MapId) • @marker.RelativeTime
                        </MudText>
                        @if (!string.IsNullOrWhiteSpace(marker.Description))
                        {
                            <MudText Typo="Typo.caption" Color="Color.Tertiary" Class="mt-1">
                                @(marker.Description.Length > 60 ? marker.Description.Substring(0, 60) + "..." : marker.Description)
                            </MudText>
                        }
                    </MudStack>
                    @if (marker.CanEdit)
                    {
                        <MudStack Row="true" Spacing="0">
                            @if (customMarkerTimer == null)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Timer"
                                              Size="Size.Small"
                                              Color="Color.Default"
                                              OnClick="@(() => OnSetTimerForCustomMarker.InvokeAsync(marker))"
                                              Title="Set timer" />
                            }
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                          Size="Size.Small"
                                          Color="Color.Primary"
                                          OnClick="@(() => OnCustomMarkerEdit.InvokeAsync(marker))"
                                          Title="Edit marker" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                          Size="Size.Small"
                                          Color="Color.Error"
                                          OnClick="@(() => OnCustomMarkerDelete.InvokeAsync(marker))"
                                          Title="Delete marker" />
                        </MudStack>
                    }
                </MudStack>
            </MudListItem>
        }
    </MudList>
    <MudDivider Class="my-3" />
}

<!-- Regular Markers Section - Grouped by Type (Virtualized) -->
@if (cachedGroups.Any())
{
    @if (CustomMarkers.Any())
    {
        <MudText Typo="Typo.h6" Class="mb-2">
            <MudIcon Icon="@Icons.Material.Filled.Place" Size="Size.Small" Class="mr-1" />
            Resource Markers
        </MudText>
    }
    <MudText Typo="Typo.caption" Class="mb-2">@totalFilteredCount marker(s) in @cachedGroups.Count type(s)</MudText>

    <div style="flex: 1; overflow-y: auto;">
        <MudVirtualize Items="@cachedGroups" Context="group" OverscanCount="5">
            @{
                var isVisible = IsGroupVisible(group.ImageType);
                var isExpanded = IsGroupExpanded(group.ImageType);
            }
            <!-- Group header -->
            <div class="marker-group-header d-flex align-center" @onclick="@(() => ToggleGroup(group.ImageType))">
                <MudIcon Icon="@(isExpanded ? Icons.Material.Filled.ExpandMore : Icons.Material.Filled.ChevronRight)"
                         Size="Size.Small" Class="mr-1" />
                <MudIconButton Icon="@(isVisible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                               Size="Size.Small"
                               Color="@(isVisible ? Color.Default : Color.Error)"
                               OnClick="@(() => ToggleGroupVisibility(group.ImageType))"
                               OnClickStopPropagation="true"
                               Title="@(isVisible ? "Hide on map" : "Show on map")"
                               Style="margin: -4px 0;" />
                <img src="@GetMarkerIconSrc(group.ImageType)"
                     alt="icon"
                     style="width: 18px; height: 18px; object-fit: contain; @(isVisible ? "" : "opacity: 0.5;")"
                     onerror="this.onerror=null;this.src='/gfx/terobjs/mm/custom.png';" />
                <MudText Typo="Typo.body2" Class="ml-1" Style="@(isVisible ? "" : "opacity: 0.5;")">@GetIconDisplayName(group.ImageType)</MudText>
                <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text" Class="ml-auto">@group.Count</MudChip>
            </div>

            <!-- Expanded content (only if expanded) -->
            @if (isExpanded)
            {
                <div class="marker-group-content">
                    <MudVirtualize Items="@GetMarkersForGroup(group.ImageType)" Context="marker" OverscanCount="5">
                        @{
                            var markerTimer = GetTimerForMarker(marker.Id);
                        }
                        <MudListItem T="string" OnClick="@(() => OnMarkerSelected.InvokeAsync(marker))" Class="py-1" Dense="true">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="width: 100%;">
                                <MudStack Row="false" Spacing="0" Style="flex: 1; min-width: 0;">
                                    <MudText Typo="Typo.body2">@marker.Name</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @GetMapName(marker.Map) • @marker.Position.X, @marker.Position.Y
                                    </MudText>
                                </MudStack>
                                @if (markerTimer != null)
                                {
                                    <TimerBadge Timer="@markerTimer" />
                                }
                                else
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Timer"
                                                   Size="Size.Small"
                                                   Color="Color.Default"
                                                   OnClick="@(() => OnSetTimerForMarker.InvokeAsync(marker))"
                                                   OnClickStopPropagation="true"
                                                   Title="Set timer" />
                                }
                            </MudStack>
                        </MudListItem>
                    </MudVirtualize>
                </div>
            }
        </MudVirtualize>
    </div>
}
else if (!CustomMarkers.Any())
{
    <MudAlert Severity="Severity.Info" Dense="true">
        @(string.IsNullOrWhiteSpace(markerFilter) ? "No markers available" : "No markers match filter")
    </MudAlert>
}

