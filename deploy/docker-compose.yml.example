# Docker Compose stack for HnH Mapper production deployment (MULTI-TENANT)
# Includes: API service, Web service, Caddy reverse proxy, and Watchtower for auto-updates
#
# IMPORTANT: Replace 'OWNER' in image names with your GitHub username/organization
# Example: ghcr.io/yourusername/hnhmapper-api:main
#
# Prerequisites:
# - Create /srv/hnh-map directory on the host with appropriate permissions
# - Copy this file and Caddyfile to /opt/hnhmap/ on the VPS
# - Run: docker compose up -d
#
# For private images, login to GHCR first:
#   echo $PAT | docker login ghcr.io -u USERNAME --password-stdin
#
# Multi-Tenancy Notes:
# - Default tenant "default-tenant-1" created automatically on first startup
# - Bootstrap admin assigned to default tenant (username: admin, password: admin123!)
# - Database migrations auto-apply (creates multi-tenant tables)
# - Self-registration disabled - new users require invitation codes
# - Full documentation: see deploy/VPS-SETUP.md and deploy/FIRST-TIME-SETUP.md

services:
  # ============================================================================
  # API Service - Handles game client communication and backend operations
  # ============================================================================
  api:
    # Pull image from GitHub Container Registry
    # Replace OWNER with your GitHub username or organization
    image: ghcr.io/OWNER/hnhmapper-api:main
    
    # Build configuration (used when building locally instead of pulling from registry)
    # Uncomment 'build' section and comment out 'image' to build locally
    # build:
    #   context: ..
    #   dockerfile: docker/api.Dockerfile
    #   args:
    #     BUILD_VERSION: ${BUILD_VERSION:-dev}
    #     BUILD_COMMIT: ${BUILD_COMMIT:-dev}
    #     BUILD_DATE: ${BUILD_DATE:-1970-01-01T00:00:00Z}
    
    container_name: hnhm-api
    
    # Restart policy: always restart unless manually stopped
    restart: unless-stopped
    
    # Environment variables for the API service
    environment:
      # Path to shared data storage (maps, database, keys)
      # Multi-tenant structure: /data/tenants/{tenantId}/grids/
      - GridStorage=/data

      # ASP.NET Core environment (Production for security hardening)
      - ASPNETCORE_ENVIRONMENT=Production

      # Security settings (disable CORS, HTTPS redirect handled by Caddy)
      - EnableCors=false
      - EnableHttpsRedirect=false

      # Bootstrap admin configuration (MULTI-TENANT)
      # On first startup:
      # 1. Default tenant "default-tenant-1" is created automatically
      # 2. Admin user is created and assigned to default tenant
      # 3. Admin given TenantAdmin role with all permissions
      # 4. No approval workflow required (PendingApproval = false)
      # ⚠️ CRITICAL: Change the password immediately after first login!
      - BootstrapAdmin__Enabled=true
      - BootstrapAdmin__Username=admin
      - BootstrapAdmin__Password=admin123!

      # Disable self-registration for production security (MULTI-TENANT)
      # New users must use invitation codes generated by admins
      - SelfRegistration__Enabled=false
    
    # Mount host directory for persistent data storage
    # Shared between API and Web services for:
    # - SQLite database (grids.db)
    # - ASP.NET Data Protection keys (DataProtection-Keys/) - Required for cookie auth
    # - Tenant-specific tile storage (tenants/{tenantId}/grids/)
    # Multi-tenant directory structure:
    #   /srv/hnh-map/
    #   ├── grids.db                    # SQLite database with multi-tenant tables
    #   ├── DataProtection-Keys/        # Cookie encryption keys (auto-created)
    #   └── tenants/                    # Tenant-isolated file storage
    #       ├── default-tenant-1/grids/ # Default tenant tiles
    #       └── {other-tenants}/grids/  # Additional tenant tiles
    volumes:
      - /srv/hnh-map:/data

    # Connect to internal network (not exposed to host, only accessible via Caddy)
    networks:
      - hnmap
    
    # Label for Watchtower to monitor and update this service
    labels:
      - com.centurylinklabs.watchtower.enable=true
  
  # ============================================================================
  # Web Service - Blazor Server UI for user dashboard and admin panel
  # ============================================================================
  web:
    # Pull image from GitHub Container Registry
    # Replace OWNER with your GitHub username or organization
    image: ghcr.io/OWNER/hnhmapper-web:main
    
    # Build configuration (used when building locally instead of pulling from registry)
    # Uncomment 'build' section and comment out 'image' to build locally
    # build:
    #   context: ..
    #   dockerfile: docker/web.Dockerfile
    #   args:
    #     BUILD_VERSION: ${BUILD_VERSION:-dev}
    #     BUILD_COMMIT: ${BUILD_COMMIT:-dev}
    #     BUILD_DATE: ${BUILD_DATE:-1970-01-01T00:00:00Z}
    
    container_name: hnhm-web
    
    # Restart policy: always restart unless manually stopped
    restart: unless-stopped
    
    # Environment variables for the Web service
    environment:
      # Path to shared data storage (must match API for cookie key sharing)
      - GridStorage=/data
      
      # ASP.NET Core environment (Production for security hardening)
      - ASPNETCORE_ENVIRONMENT=Production
      
      # API base URL for service-to-service calls (Docker Compose internal network)
      - ApiBaseUrl=http://api:8080
      
      # Disable HTTPS redirect (Caddy handles TLS termination)
      - EnableHttpsRedirect=false
    
    # Mount host directory for persistent data storage
    # Shares the same volume as API for cookie encryption keys
    volumes:
      - /srv/hnh-map:/data
    
    # Connect to internal network (not exposed to host)
    networks: 
      - hnmap
    
    # Label for Watchtower to monitor and update this service
    labels:
      - com.centurylinklabs.watchtower.enable=true
  
  # ============================================================================
  # Caddy Reverse Proxy - Routes traffic to API and Web services with HTTPS
  # ============================================================================
  caddy:
    # Official Caddy image (Alpine-based, lightweight)
    image: caddy:2

    container_name: hnhm-caddy

    # Restart policy: always restart unless manually stopped
    restart: unless-stopped

    # Expose HTTP and HTTPS ports to the host (public access points)
    ports:
      - "80:80"    # HTTP (auto-redirects to HTTPS)
      - "443:443"  # HTTPS

    # Mount Caddyfile configuration and persistent certificate storage
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data      # Let's Encrypt certificates (persistent)
      - caddy_config:/config  # Caddy configuration (persistent)
    
    # Connect to internal network to communicate with API and Web
    networks: 
      - hnmap
    
    # Label for Watchtower to monitor Caddy updates (optional)
    labels:
      - com.centurylinklabs.watchtower.enable=true
  
  # ============================================================================
  # Watchtower - Automatic container updates from GHCR
  # ============================================================================
  watchtower:
    # Official Watchtower image for automatic Docker updates
    image: containrrr/watchtower
    
    container_name: hnhm-watchtower
    
    # Restart policy: always restart unless manually stopped
    restart: unless-stopped
    
    # Watchtower configuration:
    # --interval 60: Check for updates every 60 seconds
    # --label-enable: Only update containers with watchtower.enable=true label
    command: --interval 60 --label-enable
    
    # Mount Docker socket to control containers (required for Watchtower)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    
    # Connect to internal network (Watchtower doesn't need it, but included for consistency)
    networks: 
      - hnmap
    
    # For private GHCR images, enable registry authentication
    environment:
      - WATCHTOWER_REGISTRY_AUTH=true

# ============================================================================
# Network Definition - Internal bridge network for service communication
# ============================================================================
networks:
  hnmap:
    # Bridge driver creates an isolated network for service-to-service communication
    # Services can reach each other by container name (e.g., http://api:8080)
    driver: bridge

# ============================================================================
# Volume Definitions - Persistent storage for Caddy certificates
# ============================================================================
volumes:
  caddy_data:
    # Stores Let's Encrypt TLS certificates and ACME account data
    # IMPORTANT: Backup this volume to preserve certificates across rebuilds
  caddy_config:
    # Stores Caddy runtime configuration and cache

